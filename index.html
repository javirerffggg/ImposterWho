<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Who?</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1c1c1e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Orbitron:wght@400;700;900&family=Creepster&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme (Default) */
            --bg-primary: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --accent-color: #007aff;
            --accent-hover: #0051d5;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(42, 42, 45, 0.65);
            --glass-blur: 12px;
            --glass-border-color: rgba(230, 230, 230, 0.15);
            
            /* Animation Variables */
            --transition-speed: 0.3s;
            --bounce-curve: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Gradient Variables */
            --gradient-color-1: #1c1c1e;
            --gradient-color-2: #2c2c2e;
        }

        /* Light Theme */
        body.theme-light {
            --bg-primary: #F5F5F7;
            --bg-secondary: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --accent-color: #007aff;
            --accent-hover: #0051d5;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border-color: rgba(30, 30, 30, 0.08);
            --gradient-color-1: #F5F5F7;
            --gradient-color-2: #E8E8ED;
        }

        /* Neon Theme */
        body.theme-neon {
            --bg-primary: #101010;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-color: #FF00FF;
            --accent-hover: #CC00CC;
            --danger-color: #ff0066;
            --success-color: #00ff99;
            --warning-color: #ffff00;
            --glass-bg: rgba(26, 26, 26, 0.7);
            --glass-border-color: rgba(255, 0, 255, 0.4);
            --gradient-color-1: #101010;
            --gradient-color-2: #1a1a1a;
        }

        body.theme-neon .liquid-glass,
        body.theme-neon .liquid-button,
        body.theme-neon .player-card,
        body.theme-neon .flip-card-front,
        body.theme-neon .flip-card-back {
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }

        /* Cyberpunk Theme */
        body.theme-cyberpunk {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --text-primary: #00d9ff;
            --text-secondary: #8892b0;
            --accent-color: #ffb800;
            --accent-hover: #ff9500;
            --danger-color: #ff0080;
            --success-color: #00ff9f;
            --warning-color: #ffb800;
            --glass-bg: rgba(26, 31, 58, 0.75);
            --glass-border-color: rgba(0, 217, 255, 0.3);
            --gradient-color-1: #0a0e27;
            --gradient-color-2: #1a1f3a;
            font-family: 'Orbitron', sans-serif;
        }

        body.theme-cyberpunk::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 217, 255, 0.03) 2px,
                    rgba(0, 217, 255, 0.03) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 217, 255, 0.03) 2px,
                    rgba(0, 217, 255, 0.03) 4px
                );
            pointer-events: none;
            z-index: 1;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        body.theme-cyberpunk h1,
        body.theme-cyberpunk h2 {
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.8);
        }

        /* Galactic Theme */
        body.theme-galactic {
            --bg-primary: #0a0a1a;
            --bg-secondary: #15152a;
            --text-primary: #e0e0ff;
            --text-secondary: #8080a0;
            --accent-color: #9d4edd;
            --accent-hover: #7b2cbf;
            --danger-color: #ff006e;
            --success-color: #06ffa5;
            --warning-color: #ffbe0b;
            --glass-bg: rgba(21, 21, 42, 0.6);
            --glass-border-color: rgba(157, 78, 221, 0.3);
            --gradient-color-1: #0a0a1a;
            --gradient-color-2: #15152a;
        }

        body.theme-galactic .liquid-glass,
        body.theme-galactic .liquid-button {
            border: 1px solid rgba(157, 78, 221, 0.5);
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.2);
        }

        /* Stars Animation for Galactic Theme */
        .star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: twinkle 3s infinite;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Halloween Theme */
        body.theme-halloween {
            --bg-primary: #1a0f0f;
            --bg-secondary: #2a1a1a;
            --text-primary: #ff8c00;
            --text-secondary: #ffa500;
            --accent-color: #ff6600;
            --accent-hover: #cc5200;
            --danger-color: #8b0000;
            --success-color: #ff8c00;
            --warning-color: #ffa500;
            --glass-bg: rgba(42, 26, 26, 0.8);
            --glass-border-color: rgba(255, 140, 0, 0.3);
        }

        /* Christmas Theme */
        body.theme-christmas {
            --bg-primary: #0a1f0a;
            --bg-secondary: #1a2f1a;
            --text-primary: #ffffff;
            --text-secondary: #b0e0b0;
            --accent-color: #c41e3a;
            --accent-hover: #a01828;
            --danger-color: #c41e3a;
            --success-color: #0f8558;
            --warning-color: #ffd700;
            --glass-bg: rgba(26, 47, 26, 0.8);
            --glass-border-color: rgba(196, 30, 58, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(45deg, var(--gradient-color-1), var(--gradient-color-2), var(--gradient-color-1));
            background-size: 400% 400%;
            animation: gradientBG 30s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            transition: background 0.6s ease;
        }

        body.theme-halloween h1,
        body.theme-halloween h2 {
            font-family: 'Creepster', cursive;
        }

        body.theme-cyberpunk * {
            position: relative;
            z-index: 2;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glitch Effect for Cyberpunk */
        .glitch {
            animation: glitch 1s linear infinite;
        }

        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }

        /* Snowflakes for Christmas */
        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation: fall linear infinite;
            color: white;
            font-size: 20px;
            opacity: 0.8;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Ghost for Halloween */
        .ghost {
            position: fixed;
            font-size: 40px;
            z-index: 9999;
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* Progress Bar */
        .progress-bar-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 9998;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
            width: 0%;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .progress-bar.complete {
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .screen {
            animation: slideInFromRight 0.4s ease-out;
        }

        .screen.hidden {
            display: none;
        }

        .screen.slide-out-to-left {
            animation: slideOutToLeft 0.4s ease-in forwards;
        }

        .screen.slide-in-from-right {
            animation: slideInFromRight 0.4s ease-out forwards;
        }

        .screen.zoom-in {
            animation: zoomIn 0.4s ease-out forwards;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutToLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1, h2 {
            font-family: 'Russo One', sans-serif;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Title Click Counter */
        .click-counter {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            line-height: 25px;
            font-size: 0.8rem;
            text-align: center;
            margin-left: 10px;
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* Title Special Animation */
        @keyframes titleSecret {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.2) translateY(-10px); }
            100% { transform: rotateY(360deg) scale(1); }
        }

        .title-secret-animation {
            animation: titleSecret 1s ease-in-out;
        }

        .liquid-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all var(--transition-speed) ease;
        }

        .liquid-button {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            color: var(--text-primary);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .liquid-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-color);
        }

        .liquid-button:active {
            transform: scale(0.95) translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .liquid-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .liquid-button.primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            border-color: var(--accent-color);
        }

        .liquid-button.danger {
            background: linear-gradient(135deg, var(--danger-color), #cc0000);
            border-color: var(--danger-color);
        }

        /* Sound Toggle Button */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: all var(--transition-speed) ease;
            font-size: 1.5rem;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.4);
        }

        .sound-toggle:active {
            transform: scale(0.95);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideInFromRight 0.3s ease-out;
            max-width: 300px;
        }

        .toast.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Particles */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particleExplode 0.8s ease-out forwards;
        }

        @keyframes particleExplode {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* Player Input Section */
        .input-section {
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            transition: all var(--transition-speed) ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            animation: focusPulse 2s ease-in-out infinite;
        }

        @keyframes focusPulse {
            0%, 100% {
                box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(0, 122, 255, 0.2);
            }
        }

        /* Player List */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .player-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            border-radius: 16px;
            transition: all var(--transition-speed) ease;
        }

        .player-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .player-card.new-player-entry {
            animation: slideInFromBottom 0.4s var(--bounce-curve);
        }

        .player-card.special-player {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.5);
            animation: specialGlow 2s ease-in-out infinite;
        }

        @keyframes specialGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 122, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 122, 255, 0.8); }
        }

        .player-avatar-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
            transition: background-color 0.1s ease;
        }

        .player-avatar-svg {
            width: 30px;
            height: 30px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .player-name {
            flex: 1;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .remove-player {
            background: transparent;
            border: none;
            color: var(--danger-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: all var(--transition-speed) ease;
            border-radius: 8px;
        }

        .remove-player:hover {
            background: rgba(255, 59, 48, 0.1);
            transform: rotate(90deg);
        }

        .remove-player:active {
            transform: scale(0.95) rotate(90deg);
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .color-option:active {
            transform: scale(0.95);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }

        /* Avatar Selector */
        .avatar-selector-btn {
            padding: 0.75rem 1.5rem;
            margin-top: 0.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border-color);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.9rem;
        }

        .avatar-selector-btn:hover {
            border-color: var(--accent-color);
        }

        .avatar-selector-btn:active {
            transform: scale(0.95);
        }

        /* Avatar Modal */
        .avatar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .avatar-modal.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .avatar-modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            border: 2px solid var(--glass-border-color);
            background: var(--glass-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .avatar-option:active {
            transform: scale(0.95);
        }

        .avatar-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        .avatar-option svg {
            width: 40px;
            height: 40px;
        }

        /* Categories */
        .categories {
            display: grid;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .category-item:hover {
            border-color: var(--accent-color);
            transform: translateX(5px);
        }

        .category-item:active {
            transform: scale(0.95);
        }

        .category-item.selected {
            box-shadow: 0 0 15px var(--accent-color);
            border: 2px solid var(--accent-color);
        }

        .category-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass-bg);
            transition: all var(--transition-speed) ease;
        }

        .category-checkbox svg {
            width: 16px;
            height: 16px;
            opacity: 0;
            transform: scale(0);
            transition: all var(--transition-speed) var(--bounce-curve);
        }

        input[type="checkbox"] {
            display: none;
        }

        input[type="checkbox"]:checked + .category-item .category-checkbox {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        input[type="checkbox"]:checked + .category-item .category-checkbox svg {
            opacity: 1;
            transform: scale(1);
        }

        input[type="checkbox"]:checked + .category-item {
            box-shadow: 0 0 15px var(--accent-color);
            border: 2px solid var(--accent-color);
        }

        /* Theme Selector */
        .theme-selector {
            margin: 1.5rem 0;
        }

        .theme-selector h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 0.75rem;
        }

        .theme-option {
            padding: 0.75rem;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border-color);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-speed) ease;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .theme-option:active {
            transform: scale(0.95);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
        }

        /* Colorblind Mode */
        .accessibility-options {
            margin: 1.5rem 0;
        }

        .accessibility-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border-color);
            border-radius: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--text-primary);
            top: 3px;
            left: 3px;
            transition: all var(--transition-speed) ease;
        }

        input[type="checkbox"]:checked ~ .toggle-switch {
            background: var(--accent-color);
        }

        input[type="checkbox"]:checked ~ .toggle-switch::after {
            left: 25px;
        }

        /* Game Screen */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .flip-card {
            perspective: 1000px;
            height: 200px;
            cursor: pointer;
        }

        .flip-card:active {
            transform: scale(0.95);
        }

        .flip-card.nudge {
            animation: nudge 2s ease-in-out infinite;
        }

        @keyframes nudge {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card:hover .flip-card-inner {
            transform: rotateY(5deg);
        }

        .flip-card.shake {
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .flip-card-front {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
        }

        .flip-card-back {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            transform: rotateY(180deg);
        }

        .card-player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-player-avatar svg {
            width: 35px;
            height: 35px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .card-player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card-role-content {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.4s var(--bounce-curve) 0.3s;
        }

        .flip-card.is-flipped .card-role-content {
            opacity: 1;
            transform: scale(1);
        }

        .role-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
        }

        .card-role {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .card-role.impostor {
            animation: textGlitch 0.5s ease 0.3s;
        }

        .card-role.detective {
            animation: scannerEffect 1s ease 0.3s;
        }

        @keyframes textGlitch {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 2px); text-shadow: 2px -2px var(--danger-color); }
            75% { transform: translate(2px, -2px); text-shadow: -2px 2px var(--danger-color); }
        }

        @keyframes scannerEffect {
            0% { opacity: 0; filter: brightness(3); }
            100% { opacity: 1; filter: brightness(1); }
        }

        .card-word {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Achievement Badge */
        .achievement-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1c1c1e;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 0.5rem;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
            animation: badgeGlow 2s ease-in-out infinite;
        }

        @keyframes badgeGlow {
            0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 4px 16px rgba(255, 215, 0, 0.8); }
        }

        /* Starting Player Section */
        .starting-player-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        #starting-player-announcement {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        #starting-player-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulseRotate 3s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes pulseRotate {
            0%, 100% {
                box-shadow: 0 0 30px currentColor;
                transform: scale(1) rotate(0deg);
            }
            50% {
                box-shadow: 0 0 50px currentColor;
                transform: scale(1.05) rotate(180deg);
            }
        }

        #starting-player-avatar svg {
            width: 60px;
            height: 60px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        #starting-reason {
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: 12px;
            position: relative;
        }

        #starting-reason::before {
            content: '"';
            position: absolute;
            top: -10px;
            left: 10px;
            font-size: 4rem;
            color: var(--accent-color);
            opacity: 0.3;
            font-family: Georgia, serif;
        }

        /* Results Screen */
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color);
            border-radius: 16px;
            animation: slideInFromBottom 0.4s ease-out backwards;
        }

        .result-item:nth-child(1) { animation-delay: 0.1s; }
        .result-item:nth-child(2) { animation-delay: 0.2s; }
        .result-item:nth-child(3) { animation-delay: 0.3s; }
        .result-item:nth-child(4) { animation-delay: 0.4s; }
        .result-item:nth-child(5) { animation-delay: 0.5s; }
        .result-item:nth-child(6) { animation-delay: 0.6s; }

        .result-item.impostor {
            border: 2px solid var(--danger-color);
            box-shadow: 0 0 20px rgba(255, 59, 48, 0.3);
        }

        .result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-avatar svg {
            width: 30px;
            height: 30px;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .result-role {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .result-role-icon {
            width: 20px;
            height: 20px;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .spinner-eye {
            width: 100%;
            height: 100%;
            border: 4px solid var(--accent-color);
            border-radius: 50%;
            position: relative;
            animation: spinnerRotate 2s linear infinite;
        }

        .spinner-eye::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: pupilMove 1s ease-in-out infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pupilMove {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(0.7); }
        }

        .loading-text {
            margin-top: 1.5rem;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .game-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 1rem;
            }

            .flip-card {
                height: 180px;
            }

            .liquid-glass {
                padding: 1.5rem;
            }

            .theme-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Hidden SVG Icons */
        .hidden-svg {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Sound Toggle -->
    <div class="sound-toggle" id="sound-toggle" title="Sonidos">
        <span id="sound-icon">游댉</span>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="screen">
            <h1 id="main-title">Imposter Who?</h1>
            
            <div class="liquid-glass">
                <div class="input-section">
                    <h2>A침adir Jugadores</h2>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="player-name-input" 
                            placeholder="Nombre del jugador"
                            autocomplete="off"
                        >
                        <button class="liquid-button primary" id="add-player-btn">A침adir</button>
                    </div>
                    
                    <div class="color-picker" id="color-picker"></div>
                    
                    <button class="liquid-button avatar-selector-btn" id="open-avatar-modal">
                        Elegir Avatar
                    </button>
                    
                    <div id="player-list" class="player-list"></div>
                </div>

                <div class="theme-selector">
                    <h3>Tema Visual</h3>
                    <div class="theme-options">
                        <div class="theme-option active" data-theme="theme-dark">Oscuro</div>
                        <div class="theme-option" data-theme="theme-light">Claro</div>
                        <div class="theme-option" data-theme="theme-neon">Ne칩n</div>
                        <div class="theme-option" data-theme="theme-cyberpunk">Cyberpunk</div>
                        <div class="theme-option" data-theme="theme-galactic">Gal치ctico</div>
                    </div>
                </div>

                <div class="accessibility-options">
                    <label class="accessibility-toggle">
                        <span>Modo Dalt칩nico</span>
                        <input type="checkbox" id="colorblind-toggle" hidden>
                        <div class="toggle-switch"></div>
                    </label>
                </div>

                <h2 style="margin-top: 2rem;">Categor칤as</h2>
                <div class="categories" id="categories"></div>

                <button class="liquid-button primary" id="start-game-btn" style="width: 100%; margin-top: 1.5rem;">
                    Comenzar Juego
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <h1 class="font-title">Imposter Who?</h1>
            
            <div class="liquid-glass">
                <div class="starting-player-section">
                    <div id="starting-player-announcement">Jugador que comienza</div>
                    <div id="starting-player-avatar"></div>
                    <div id="starting-player-name" style="font-weight: 600; font-size: 1.2rem;"></div>
                    <div id="starting-reason"></div>
                </div>

                <div class="game-grid" id="game-grid"></div>

                <button class="liquid-button primary" id="reveal-roles-btn" style="width: 100%; margin-top: 2rem;">
                    Revelar Todos los Roles
                </button>
                
                <button class="liquid-button" id="new-game-btn" style="width: 100%; margin-top: 1rem;">
                    Nueva Partida
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen hidden">
            <h1>Resultados</h1>
            
            <div class="liquid-glass">
                <div id="results-list" class="results-list"></div>

                <button class="liquid-button primary" id="play-again-btn" style="width: 100%; margin-top: 2rem;">
                    Jugar de Nuevo
                </button>
                
                <button class="liquid-button" id="change-players-btn" style="width: 100%; margin-top: 1rem;">
                    Cambiar Jugadores
                </button>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatar-modal" class="avatar-modal hidden">
        <div class="avatar-modal-content">
            <h2>Selecciona un Avatar</h2>
            <div class="avatar-grid" id="avatar-grid"></div>
            <button class="liquid-button primary" id="close-avatar-modal" style="width: 100%;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="loading-spinner">
            <div class="spinner-eye"></div>
        </div>
        <div class="loading-text">Generando con IA...</div>
    </div>

    <!-- Hidden SVG Icons -->
    <div class="hidden-svg">
        <!-- Impostor Icon -->
        <svg id="icon-impostor" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM9 10H11V12H9V10ZM13 10H15V12H13V10ZM10 16C10 14.9 10.9 14 12 14C13.1 14 14 14.9 14 16H10Z" fill="currentColor"/>
        </svg>

        <!-- Detective Icon -->
        <svg id="icon-detective" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
            <circle cx="12" cy="8" r="3" fill="var(--bg-primary)"/>
            <circle cx="12" cy="8" r="1.5" fill="currentColor"/>
        </svg>

        <!-- Civil Icon -->
        <svg id="icon-civil" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
        </svg>

        <!-- Checkmark Icon -->
        <svg id="icon-checkmark" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
        </svg>

        <!-- Avatar Icons -->
        <svg id="avatar-circle" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <circle cx="25" cy="25" r="20" fill="currentColor"/>
        </svg>

        <svg id="avatar-square" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="10" width="30" height="30" fill="currentColor"/>
        </svg>

        <svg id="avatar-triangle" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="25,10 45,40 5,40" fill="currentColor"/>
        </svg>

        <svg id="avatar-star" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="25,5 30,20 45,20 33,28 38,43 25,35 12,43 17,28 5,20 20,20" fill="currentColor"/>
        </svg>

        <svg id="avatar-heart" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M25,45 L22,42.2 C11,32.1 5,26.6 5,19.5 C5,13.8 9.3,10 14.5,10 C18,10 21.4,11.8 23,14.5 C24.6,11.8 28,10 31.5,10 C36.7,10 41,13.8 41,19.5 C41,26.6 35,32.1 24,42.2 L25,45 Z" fill="currentColor"/>
        </svg>

        <svg id="avatar-diamond" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="25,5 45,25 25,45 5,25" fill="currentColor"/>
        </svg>

        <svg id="avatar-hexagon" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="25,5 40,15 40,35 25,45 10,35 10,15" fill="currentColor"/>
        </svg>

        <svg id="avatar-pentagon" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="25,5 45,20 38,42 12,42 5,20" fill="currentColor"/>
        </svg>

        <svg id="avatar-moon" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M25,5 C15,5 7,13 7,23 C7,33 15,41 25,41 C27,41 29,40.7 31,40 C25,38 21,32 21,25 C21,18 25,12 31,10 C29,9.3 27,9 25,9 C15,9 7,17 7,27 C7,37 15,45 25,45 C35,45 43,37 43,27 C43,15 35,5 25,5 Z" fill="currentColor"/>
        </svg>

        <svg id="avatar-lightning" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <polygon points="20,5 15,25 25,25 20,45 35,20 25,20 30,5" fill="currentColor"/>
        </svg>

        <svg id="avatar-cloud" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M38,25 C38,22 36,19 33,18 C32,14 28,11 24,11 C19,11 15,15 15,20 C12,20 10,22 10,25 C10,28 12,30 15,30 L38,30 C41,30 43,28 43,25 C43,22 41,20 38,20 Z" fill="currentColor"/>
        </svg>

        <svg id="avatar-flower" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <circle cx="25" cy="15" r="6" fill="currentColor"/>
            <circle cx="35" cy="25" r="6" fill="currentColor"/>
            <circle cx="25" cy="35" r="6" fill="currentColor"/>
            <circle cx="15" cy="25" r="6" fill="currentColor"/>
            <circle cx="25" cy="25" r="5" fill="currentColor"/>
        </svg>

        <svg id="avatar-sun" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <circle cx="25" cy="25" r="10" fill="currentColor"/>
            <line x1="25" y1="5" x2="25" y2="12" stroke="currentColor" stroke-width="3"/>
            <line x1="25" y1="38" x2="25" y2="45" stroke="currentColor" stroke-width="3"/>
            <line x1="5" y1="25" x2="12" y2="25" stroke="currentColor" stroke-width="3"/>
            <line x1="38" y1="25" x2="45" y2="25" stroke="currentColor" stroke-width="3"/>
            <line x1="11" y1="11" x2="16" y2="16" stroke="currentColor" stroke-width="3"/>
            <line x1="34" y1="34" x2="39" y2="39" stroke="currentColor" stroke-width="3"/>
            <line x1="39" y1="11" x2="34" y2="16" stroke="currentColor" stroke-width="3"/>
            <line x1="16" y1="34" x2="11" y2="39" stroke="currentColor" stroke-width="3"/>
        </svg>

        <svg id="avatar-rocket" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M25,5 L30,15 L25,20 L20,15 Z M15,25 L10,20 L15,15 L20,20 Z M35,25 L40,20 L35,15 L30,20 Z M25,30 L20,35 L15,40 L20,40 L25,35 L30,40 L35,40 L30,35 Z" fill="currentColor"/>
        </svg>

        <svg id="avatar-anchor" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <circle cx="25" cy="12" r="5" fill="currentColor"/>
            <rect x="23" y="17" width="4" height="20" fill="currentColor"/>
            <path d="M15,37 L15,30 L10,35 L15,37 M35,37 L35,30 L40,35 L35,37 M20,37 L30,37 L30,40 L20,40 Z" fill="currentColor"/>
        </svg>
    </div>

    <script type="module">
        // Console Easter Egg
        console.log('%c轎덕뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎', 'color: #007aff; font-size: 14px;');
        console.log('%c轎   游꿠 IMPOSTER WHO? 游꿠            轎', 'color: #007aff; font-size: 16px; font-weight: bold;');
        console.log('%c轎뛱뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎', 'color: #007aff; font-size: 14px;');
        console.log('%c춰Hola, curioso desarrollador! 游녦', 'color: #34c759; font-size: 14px; font-weight: bold;');
        console.log('%cHas encontrado un secreto. 쯉ab칤as que puedes hacer clic 10 veces en el t칤tulo?', 'color: #ff9500; font-size: 12px;');
        console.log('%cCreado con 仇벒잺 por un impostor profesional', 'color: #a1a1a6; font-size: 10px; font-style: italic;');

        // Game State
        let gameState = {
            players: [],
            selectedColor: '#ff6b6b',
            selectedAvatar: 'avatar-circle',
            categories: ['Pel칤culas', 'Animales', 'Comida', 'Deportes', 'Pa칤ses', 'Profesiones'],
            selectedCategories: ['Pel칤culas', 'Animales', 'Comida'],
            currentTheme: 'theme-dark',
            colorblindMode: false,
            soundEnabled: true,
            titleClickCount: 0,
            startButtonClickCount: 0,
            lastStartButtonClick: 0,
            gamesPlayed: 0,
            impostorStreaks: {},
            quantumUnlocked: false,
            cardNudgeTimers: {}
        };

        // Color palette
        const colors = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
            '#dfe6e9', '#74b9ff', '#a29bfe', '#fd79a8', '#fdcb6e',
            '#e17055', '#00b894', '#0984e3', '#6c5ce7', '#d63031'
        ];

        // Avatar list
        const avatars = [
            'avatar-circle', 'avatar-square', 'avatar-triangle', 'avatar-star',
            'avatar-heart', 'avatar-diamond', 'avatar-hexagon', 'avatar-pentagon',
            'avatar-moon', 'avatar-lightning', 'avatar-cloud', 'avatar-flower',
            'avatar-sun', 'avatar-rocket', 'avatar-anchor'
        ];

        // Special names
        const specialNames = ['gemini', 'google', 'ai', 'bard', 'javier', 'impostor', 'detective'];
        
        // Special greetings
        const specialGreetings = {
            'gemini': '춰Bienvenida, IA! Intenta no analizar demasiado el juego.',
            'google': '춰El gigante se ha unido! No hagas b칰squedas trampa.',
            'ai': '춰Una IA entre humanos! 쯉er치s el impostor perfecto?',
            'bard': '춰El poeta ha llegado! Que tus versos confundan al impostor.',
            'javier': '춰El creador se ha unido a la partida! 游꿡',
            'impostor': '쮼n serio? Ya sabemos qui칠n eres... 游땚',
            'detective': '춰El investigador ha llegado! Tienes ventaja injusta.'
        };

        // Impatient button messages
        const impatientMessages = [
            '쯏a merito?',
            '춰Tranquilo, impostor!',
            'La paciencia es una virtud... que t칰 no tienes',
            'Pulsar m치s veces no har치 que aparezcan m치s jugadores',
            '쯊ienes prisa por perder?',
            'Respira profundo y cuenta hasta 3...',
            '춰Calma! Rome wasn\'t built in a day',
            'Click, click, click... 쯦e sientes mejor?'
        ];

        // Quantum Physics words
        const quantumWords = [
            'Gato de Schr칬dinger', 'Entrelazamiento', 'Fluzo-condensador',
            'Part칤cula de Caramelo', 'Bos칩n de Gominola', 'Onda Cu치ntica',
            'Superposici칩n', 'Teletransportaci칩n', 'T칰nel Temporal',
            'Esp칤n de Chocolate'
        ];

        // Achievement titles
        const impostorAchievements = [
            '游꿠 Nacido para Enga침ar',
            '游돗勇 Agente Encubierto Veterano',
            '游꿝 Maestro del Disfraz',
            '游놏 El Impostor Inevitable',
            '游 Leyenda del Enga침o'
        ];

        // Audio context for sounds
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Sound generator functions
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'pop':
                        oscillator.frequency.value = 800;
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.1);
                        break;
                    case 'swoosh':
                        oscillator.frequency.value = 1200;
                        oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                    case 'tick':
                        oscillator.frequency.value = 1000;
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.05);
                        break;
                    case 'trash':
                        oscillator.frequency.value = 300;
                        oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                        break;
                    case 'suspense':
                        oscillator.frequency.value = 200;
                        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + 0.5);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                    case 'boop':
                        oscillator.frequency.value = 600;
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.15);
                        break;
                }
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // Vibration function
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeColorPicker();
            initializeAvatarSelector();
            initializeCategories();
            initializeThemeSelector();
            initializeColorblindMode();
            initializeSoundToggle();
            initializeEasterEggs();
            loadGameState();
            setupEventListeners();
            checkAndApplyFestiveTheme();
            updateProgressBar();
        });

        // Festive Theme Detection
        function checkAndApplyFestiveTheme() {
            const now = new Date();
            const month = now.getMonth() + 1;
            
            if (month === 10) {
                createFloatingGhosts();
            } else if (month === 12) {
                createSnowfall();
            }
            
            // Check for Galactic theme stars
            if (document.body.classList.contains('theme-galactic')) {
                createStarField();
            }
        }

        // Create Snowfall Effect
        function createSnowfall() {
            setInterval(() => {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.textContent = '仇';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                snowflake.style.opacity = Math.random();
                snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                document.body.appendChild(snowflake);
                
                setTimeout(() => snowflake.remove(), 5000);
            }, 300);
        }

        // Create Floating Ghosts
        function createFloatingGhosts() {
            for (let i = 0; i < 3; i++) {
                const ghost = document.createElement('div');
                ghost.className = 'ghost';
                ghost.textContent = '游놑';
                ghost.style.left = (Math.random() * 80 + 10) + '%';
                ghost.style.top = (Math.random() * 80 + 10) + '%';
                ghost.style.animationDelay = (Math.random() * 2) + 's';
                document.body.appendChild(ghost);
            }
        }

        // Create Star Field for Galactic Theme
        function createStarField() {
            // Remove existing stars
            document.querySelectorAll('.star').forEach(star => star.remove());
            
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(star);
            }
        }

        // Initialize Sound Toggle
        function initializeSoundToggle() {
            const soundToggle = document.getElementById('sound-toggle');
            const soundIcon = document.getElementById('sound-icon');
            
            soundToggle.addEventListener('click', () => {
                gameState.soundEnabled = !gameState.soundEnabled;
                soundIcon.textContent = gameState.soundEnabled ? '游댉' : '游댆';
                playSound('tick');
                saveGameState();
                vibrate(50);
            });
        }

        // Update Progress Bar
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const hasMinPlayers = gameState.players.length >= 3;
            const hasCategories = gameState.selectedCategories.length > 0;
            
            let progress = 0;
            if (hasMinPlayers) progress += 50;
            if (hasCategories) progress += 50;
            
            progressBar.style.width = progress + '%';
            
            if (progress === 100) {
                progressBar.classList.add('complete');
            } else {
                progressBar.classList.remove('complete');
            }
        }

        // Initialize Easter Eggs
        function initializeEasterEggs() {
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.addEventListener('click', handleTitleClick);
            }
        }

        // Title Click Handler
        function handleTitleClick() {
            gameState.titleClickCount++;
            
            if (gameState.titleClickCount >= 5 && gameState.titleClickCount < 10) {
                const mainTitle = document.getElementById('main-title');
                let counter = mainTitle.querySelector('.click-counter');
                if (!counter) {
                    counter = document.createElement('span');
                    counter.className = 'click-counter';
                    mainTitle.appendChild(counter);
                }
                counter.textContent = gameState.titleClickCount;
                playSound('tick');
            }
            
            if (gameState.titleClickCount === 10) {
                const mainTitle = document.getElementById('main-title');
                mainTitle.classList.add('title-secret-animation');
                playSound('swoosh');
                vibrate([100, 50, 100]);
                
                const counter = mainTitle.querySelector('.click-counter');
                if (counter) counter.remove();
                
                showToast('游꿀 춰Has desbloqueado el secreto del t칤tulo!');
                
                setTimeout(() => {
                    mainTitle.classList.remove('title-secret-animation');
                    gameState.titleClickCount = 0;
                }, 1000);
            }
        }

        // Show Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Create Confetti Effect
        function createConfetti(centerX, centerY) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd700', '#ff00ff', '#00ff99'];
            const shapes = ['餃', '郊', '郊', '驕'];
            
            for (let i = 0; i < 40; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = centerX + 'px';
                confetti.style.top = centerY + 'px';
                
                const angle = (Math.PI * 2 * i) / 40;
                const velocity = 100 + Math.random() * 200;
                const xVelocity = Math.cos(angle) * velocity;
                const yVelocity = Math.sin(angle) * velocity;
                
                confetti.style.animation = `confettiFall ${1 + Math.random()}s ease-out forwards`;
                confetti.style.transform = `translate(${xVelocity}px, ${yVelocity}px)`;
                
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
            
            playSound('pop');
        }

        // Create Particles on Card Flip
        function createParticles(element, roleColor) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = roleColor;
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                const angle = (Math.PI * 2 * i) / 20;
                const distance = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 800);
            }
        }

        // Color Picker
        function initializeColorPicker() {
            const colorPicker = document.getElementById('color-picker');
            colors.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                
                let pressTimer;
                let rainbowInterval;
                
                colorOption.addEventListener('mousedown', (e) => {
                    gameState.selectedColor = color;
                    updateColorSelection();
                    playSound('tick');
                    vibrate(30);
                    
                    pressTimer = setTimeout(() => {
                        let hue = 0;
                        rainbowInterval = setInterval(() => {
                            hue = (hue + 5) % 360;
                            const rainbowColor = `hsl(${hue}, 70%, 60%)`;
                            colorOption.style.backgroundColor = rainbowColor;
                            gameState.selectedColor = rainbowColor;
                        }, 50);
                    }, 3000);
                });
                
                colorOption.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                    if (rainbowInterval) {
                        clearInterval(rainbowInterval);
                        rainbowInterval = null;
                    }
                });
                
                colorOption.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                    if (rainbowInterval) {
                        clearInterval(rainbowInterval);
                        rainbowInterval = null;
                        colorOption.style.backgroundColor = color;
                    }
                });
                
                colorOption.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    gameState.selectedColor = color;
                    updateColorSelection();
                    playSound('tick');
                    vibrate(30);
                });
                
                colorPicker.appendChild(colorOption);
            });
            updateColorSelection();
        }

        function updateColorSelection() {
            document.querySelectorAll('.color-option').forEach(option => {
                const optionColor = rgbToHex(option.style.backgroundColor);
                const selectedColor = gameState.selectedColor.startsWith('hsl') 
                    ? gameState.selectedColor 
                    : rgbToHex(gameState.selectedColor);
                
                if (optionColor === selectedColor || option.style.backgroundColor === selectedColor) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            if (rgb.startsWith('hsl')) return rgb;
            const values = rgb.match(/\d+/g);
            if (!values) return rgb;
            return '#' + values.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
        }

        // Avatar Selector
        function initializeAvatarSelector() {
            const avatarGrid = document.getElementById('avatar-grid');
            avatars.forEach(avatarId => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                const svgClone = document.getElementById(avatarId).cloneNode(true);
                svgClone.style.color = gameState.selectedColor;
                avatarOption.appendChild(svgClone);
                avatarOption.addEventListener('click', () => {
                    gameState.selectedAvatar = avatarId;
                    updateAvatarSelection();
                    playSound('pop');
                    vibrate(30);
                });
                avatarGrid.appendChild(avatarOption);
            });
            updateAvatarSelection();
        }

        function updateAvatarSelection() {
            document.querySelectorAll('.avatar-option').forEach((option, index) => {
                if (avatars[index] === gameState.selectedAvatar) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // Categories
        function initializeCategories() {
            const categoriesContainer = document.getElementById('categories');
            gameState.categories.forEach(category => {
                const checkboxId = `cat-${category.replace(/\s+/g, '-').toLowerCase()}`;
                const isChecked = gameState.selectedCategories.includes(category);
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
                    <label for="${checkboxId}" class="category-item ${isChecked ? 'selected' : ''}">
                        <div class="category-checkbox">
                            ${document.getElementById('icon-checkmark').outerHTML}
                        </div>
                        <span>${category}</span>
                    </label>
                `;
                
                const checkbox = wrapper.querySelector('input');
                const label = wrapper.querySelector('label');
                
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!gameState.selectedCategories.includes(category)) {
                            gameState.selectedCategories.push(category);
                            label.classList.add('selected');
                            playSound('pop');
                            vibrate(30);
                        }
                    } else {
                        gameState.selectedCategories = gameState.selectedCategories.filter(c => c !== category);
                        label.classList.remove('selected');
                        playSound('tick');
                        vibrate(20);
                    }
                    updateProgressBar();
                    saveGameState();
                });
                
                categoriesContainer.appendChild(wrapper.firstElementChild);
                categoriesContainer.appendChild(wrapper.lastElementChild);
            });
            
            checkQuantumUnlock();
        }

        // Check Quantum Unlock
        function checkQuantumUnlock() {
            const stats = JSON.parse(localStorage.getItem('imposterWhoStats') || '{}');
            const gamesPlayed = stats.gamesPlayed || 0;
            
            if (gamesPlayed >= 10 && !gameState.quantumUnlocked) {
                gameState.quantumUnlocked = true;
                addQuantumCategory();
                showToast('游댧 Nueva categor칤a desbloqueada: F칤sica Cu치ntica Avanzada!');
            }
        }

        // Add Quantum Category
        function addQuantumCategory() {
            if (!gameState.categories.includes('F칤sica Cu치ntica Avanzada')) {
                gameState.categories.push('F칤sica Cu치ntica Avanzada');
                
                const categoriesContainer = document.getElementById('categories');
                const category = 'F칤sica Cu치ntica Avanzada';
                const checkboxId = `cat-fisica-cuantica-avanzada`;
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <input type="checkbox" id="${checkboxId}">
                    <label for="${checkboxId}" class="category-item">
                        <div class="category-checkbox">
                            ${document.getElementById('icon-checkmark').outerHTML}
                        </div>
                        <span>${category}</span>
                    </label>
                `;
                
                const checkbox = wrapper.querySelector('input');
                const label = wrapper.querySelector('label');
                
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!gameState.selectedCategories.includes(category)) {
                            gameState.selectedCategories.push(category);
                            label.classList.add('selected');
                            playSound('pop');
                        }
                    } else {
                        gameState.selectedCategories = gameState.selectedCategories.filter(c => c !== category);
                        label.classList.remove('selected');
                        playSound('tick');
                    }
                    updateProgressBar();
                    saveGameState();
                });
                
                categoriesContainer.appendChild(wrapper.firstElementChild);
                categoriesContainer.appendChild(wrapper.lastElementChild);
            }
        }

        // Theme Selector
        function initializeThemeSelector() {
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    setTheme(theme);
                    playSound('swoosh');
                    vibrate(50);
                });
            });
        }

        function setTheme(theme) {
            document.body.className = '';
            document.body.classList.add(theme);
            
            const now = new Date();
            const month = now.getMonth() + 1;
            if (month === 10) document.body.classList.add('theme-halloween');
            if (month === 12) document.body.classList.add('theme-christmas');
            
            if (gameState.colorblindMode) {
                document.body.classList.add('colorblind-mode');
            }
            
            if (theme === 'theme-galactic') {
                createStarField();
            } else {
                document.querySelectorAll('.star').forEach(star => star.remove());
            }
            
            gameState.currentTheme = theme;
            
            document.querySelectorAll('.theme-option').forEach(option => {
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            saveGameState();
        }

        // Colorblind Mode
        function initializeColorblindMode() {
            const toggle = document.getElementById('colorblind-toggle');
            toggle.addEventListener('change', (e) => {
                gameState.colorblindMode = e.target.checked;
                if (e.target.checked) {
                    document.body.classList.add('colorblind-mode');
                } else {
                    document.body.classList.remove('colorblind-mode');
                }
                playSound('tick');
                saveGameState();
            });
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('add-player-btn').addEventListener('click', handleAddPlayer);
            document.getElementById('player-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAddPlayer();
            });
            document.getElementById('open-avatar-modal').addEventListener('click', () => {
                document.getElementById('avatar-modal').classList.remove('hidden');
                playSound('swoosh');
            });
            document.getElementById('close-avatar-modal').addEventListener('click', () => {
                document.getElementById('avatar-modal').classList.add('hidden');
                playSound('swoosh');
            });
            
            const startBtn = document.getElementById('start-game-btn');
            startBtn.addEventListener('click', handleStartGame);
            
            startBtn.addEventListener('click', () => {
                const now = Date.now();
                if (startBtn.disabled) {
                    if (now - gameState.lastStartButtonClick < 500) {
                        gameState.startButtonClickCount++;
                        if (gameState.startButtonClickCount >= 5) {
                            const message = impatientMessages[Math.floor(Math.random() * impatientMessages.length)];
                            showToast(message);
                            gameState.startButtonClickCount = 0;
                            vibrate([50, 50, 50]);
                        }
                    } else {
                        gameState.startButtonClickCount = 1;
                    }
                }
                gameState.lastStartButtonClick = now;
            });
            
            document.getElementById('reveal-roles-btn').addEventListener('click', handleRevealRolesClick);
            document.getElementById('new-game-btn').addEventListener('click', handleNewGame);
            document.getElementById('play-again-btn').addEventListener('click', handleNewGame);
            document.getElementById('change-players-btn').addEventListener('click', () => {
                switchScreen('results-screen', 'setup-screen');
            });
        }

        // Add Player
        function handleAddPlayer() {
            const input = document.getElementById('player-name-input');
            const name = input.value.trim();
            
            if (name && !gameState.players.find(p => p.name === name)) {
                const isSpecial = specialNames.includes(name.toLowerCase());
                const isTroll = name.toLowerCase() === 'troll';
                
                gameState.players.push({
                    name,
                    color: gameState.selectedColor,
                    avatar: gameState.selectedAvatar,
                    isSpecial,
                    isTroll
                });
                
                input.value = '';
                renderPlayerList();
                updateProgressBar();
                playSound('pop');
                vibrate(50);
                
                if (isSpecial) {
                    const greeting = specialGreetings[name.toLowerCase()];
                    if (greeting) {
                        showToast(greeting);
                    }
                }
                
                saveGameState();
            }
        }

        // Render Player List
        function renderPlayerList() {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card new-player-entry';
                if (player.isSpecial) {
                    playerCard.classList.add('special-player');
                }
                
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'player-avatar-container';
                avatarContainer.style.backgroundColor = player.color;
                
                const avatarSvg = document.getElementById(player.avatar).cloneNode(true);
                avatarSvg.classList.add('player-avatar-svg');
                avatarSvg.style.color = 'white';
                avatarContainer.appendChild(avatarSvg);
                
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-player';
                removeBtn.innerHTML = '칑';
                removeBtn.addEventListener('click', () => {
                    removePlayer(index);
                    playSound('trash');
                    vibrate(30);
                });
                
                playerCard.appendChild(avatarContainer);
                playerCard.appendChild(playerName);
                playerCard.appendChild(removeBtn);
                playerList.appendChild(playerCard);
                
                setTimeout(() => {
                    playerCard.classList.remove('new-player-entry');
                }, 400);
            });
        }

        // Remove Player
        function removePlayer(index) {
            gameState.players.splice(index, 1);
            renderPlayerList();
            updateProgressBar();
            saveGameState();
        }

        // Start Game
        async function handleStartGame() {
            if (gameState.players.length < 3) {
                alert('Se necesitan al menos 3 jugadores para comenzar');
                return;
            }
            
            if (gameState.selectedCategories.length === 0) {
                alert('Selecciona al menos una categor칤a');
                return;
            }
            
            showLoading();
            playSound('swoosh');
            vibrate(100);
            
            try {
                await assignRolesAndWords();
                await selectStartingPlayer();
                renderGameScreen();
                switchScreen('setup-screen', 'game-screen');
                updateGameStats();
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Error al iniciar el juego');
            } finally {
                hideLoading();
            }
        }

        // Update Game Stats
        function updateGameStats() {
            const stats = JSON.parse(localStorage.getItem('imposterWhoStats') || '{}');
            stats.gamesPlayed = (stats.gamesPlayed || 0) + 1;
            localStorage.setItem('imposterWhoStats', JSON.stringify(stats));
            
            if (stats.gamesPlayed >= 10) {
                checkQuantumUnlock();
            }
        }

        // Assign Roles and Words
        async function assignRolesAndWords() {
            const hasTroll = gameState.players.some(p => p.isTroll);
            const forceTrollMode = hasTroll && Math.random() < 0.25;
            
            if (forceTrollMode) {
                showToast('游븳 El Troll ha hablado... 춰Que reine el caos!');
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            const shuffled = [...gameState.players].sort(() => Math.random() - 0.5);
            const category = gameState.selectedCategories[Math.floor(Math.random() * gameState.selectedCategories.length)];
            const word = await generateWord(category);
            
            if (forceTrollMode) {
                shuffled.forEach(player => {
                    player.role = 'Impostor';
                    player.word = '???';
                    player.revealed = false;
                });
            } else {
                const impostorIndex = Math.floor(Math.random() * shuffled.length);
                const detectiveIndex = (impostorIndex + 1 + Math.floor(Math.random() * (shuffled.length - 1))) % shuffled.length;
                
                shuffled.forEach((player, index) => {
                    if (index === impostorIndex) {
                        player.role = 'Impostor';
                        player.word = '???';
                        
                        if (!gameState.impostorStreaks[player.name]) {
                            gameState.impostorStreaks[player.name] = 0;
                        }
                        gameState.impostorStreaks[player.name]++;
                        
                        if (gameState.impostorStreaks[player.name] >= 3) {
                            const achievementIndex = Math.min(
                                gameState.impostorStreaks[player.name] - 3,
                                impostorAchievements.length - 1
                            );
                            player.achievement = impostorAchievements[achievementIndex];
                        }
                    } else if (index === detectiveIndex) {
                        player.role = 'Detective';
                        player.word = word;
                        gameState.impostorStreaks[player.name] = 0;
                    } else {
                        player.role = 'Civil';
                        player.word = word;
                        gameState.impostorStreaks[player.name] = 0;
                    }
                    player.revealed = false;
                });
            }
            
            gameState.players = shuffled;
            gameState.category = category;
            gameState.secretWord = word;
        }

        // Generate Word
        async function generateWord(category) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (category === 'F칤sica Cu치ntica Avanzada') {
                return quantumWords[Math.floor(Math.random() * quantumWords.length)];
            }
            
            const words = {
                'Pel칤culas': ['Titanic', 'Avatar', 'Inception', 'Matrix', 'Avengers'],
                'Animales': ['Le칩n', 'Elefante', 'Delf칤n', '츼guila', 'Panda'],
                'Comida': ['Pizza', 'Sushi', 'Hamburguesa', 'Tacos', 'Pasta'],
                'Deportes': ['F칰tbol', 'Baloncesto', 'Tenis', 'Nataci칩n', 'Atletismo'],
                'Pa칤ses': ['Espa침a', 'Jap칩n', 'Brasil', 'Australia', 'Canad치'],
                'Profesiones': ['M칠dico', 'Profesor', 'Ingeniero', 'Chef', 'Artista']
            };
            
            const categoryWords = words[category] || ['Palabra'];
            return categoryWords[Math.floor(Math.random() * categoryWords.length)];
        }

        // Select Starting Player
        async function selectStartingPlayer() {
            await new Promise(resolve => setTimeout(resolve, 500));
            gameState.startingPlayer = gameState.players[Math.floor(Math.random() * gameState.players.length)];
            gameState.startingReason = generateStartingReason();
        }

        // Generate Starting Reason
        function generateStartingReason() {
            const playerNames = gameState.players.map(p => p.name.toLowerCase());
            
            const harryPotterNames = ['harry', 'ron', 'hermione', 'dumbledore', 'snape', 'voldemort'];
            const hasHarryPotter = harryPotterNames.some(name => playerNames.includes(name));
            if (hasHarryPotter) {
                return 'Fue elegido por el Sombrero Seleccionador';
            }
            
            const starWarsNames = ['luke', 'leia', 'han', 'vader', 'yoda', 'obi'];
            const hasStarWars = starWarsNames.some(name => playerNames.includes(name));
            if (hasStarWars) {
                return 'La Fuerza es fuerte con este';
            }
            
            const marvelNames = ['tony', 'steve', 'thor', 'hulk', 'natasha', 'peter'];
            const hasMarvel = marvelNames.some(name => playerNames.includes(name));
            if (hasMarvel) {
                return 'Los Vengadores lo han elegido';
            }
            
            const reasons = [
                'Es el m치s sospechoso',
                'Tiene la mejor estrategia',
                'Fue elegido por el destino',
                'Es el m치s experimentado',
                'Tiene la mejor suerte'
            ];
            return reasons[Math.floor(Math.random() * reasons.length)];
        }

        // Render Game Screen
        function renderGameScreen() {
            // Update background gradient with starting player color
            const root = document.documentElement;
            const playerColor = gameState.startingPlayer.color;
            root.style.setProperty('--gradient-color-1', playerColor);
            root.style.setProperty('--gradient-color-2', adjustColorBrightness(playerColor, -20));
            
            const startingPlayerAvatar = document.getElementById('starting-player-avatar');
            startingPlayerAvatar.style.backgroundColor = gameState.startingPlayer.color;
            startingPlayerAvatar.style.color = gameState.startingPlayer.color;
            startingPlayerAvatar.innerHTML = '';
            const avatarSvg = document.getElementById(gameState.startingPlayer.avatar).cloneNode(true);
            avatarSvg.style.color = 'white';
            startingPlayerAvatar.appendChild(avatarSvg);
            
            // Add click sound to avatar
            startingPlayerAvatar.addEventListener('click', () => {
                playSound('boop');
                vibrate(50);
            });
            
            document.getElementById('starting-player-name').textContent = gameState.startingPlayer.name;
            document.getElementById('starting-reason').textContent = gameState.startingReason;
            
            const gameGrid = document.getElementById('game-grid');
            gameGrid.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const card = createPlayerCard(player, index);
                gameGrid.appendChild(card);
                
                // Start nudge timer after 5 seconds
                gameState.cardNudgeTimers[index] = setTimeout(() => {
                    if (!player.revealed) {
                        card.classList.add('nudge');
                    }
                }, 5000);
            });
        }

        // Adjust Color Brightness
        function adjustColorBrightness(hex, percent) {
            const num = parseInt(hex.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        // Create Player Card
        function createPlayerCard(player, index) {
            const flipCard = document.createElement('div');
            flipCard.className = 'flip-card';
            
            // Custom back pattern with player color
            const backPattern = `
                background: linear-gradient(135deg, 
                    ${player.color}22 25%, 
                    transparent 25%, 
                    transparent 50%, 
                    ${player.color}22 50%, 
                    ${player.color}22 75%, 
                    transparent 75%, 
                    transparent);
                background-size: 20px 20px;
            `;
            
            const achievementBadge = player.achievement 
                ? `<div class="achievement-badge">${player.achievement}</div>` 
                : '';
            
            const roleClass = player.role === 'Impostor' ? 'impostor' : 
                             player.role === 'Detective' ? 'detective' : '';
            
            flipCard.innerHTML = `
                <div class="flip-card-inner">
                    <div class="flip-card-front" style="${backPattern}">
                        <div class="card-player-avatar" style="background-color: ${player.color};">
                            ${getAvatarSvg(player.avatar)}
                        </div>
                        <div class="card-player-name">${player.name}</div>
                    </div>
                    <div class="flip-card-back">
                        <div class="card-role-content">
                            ${getRoleIcon(player.role)}
                            <div class="card-role ${roleClass}">${player.role}</div>
                            <div class="card-word">${player.word}</div>
                            ${achievementBadge}
                        </div>
                    </div>
                </div>
            `;
            
            flipCard.addEventListener('click', () => {
                if (!player.revealed) {
                    // Clear nudge timer and remove nudge class
                    clearTimeout(gameState.cardNudgeTimers[index]);
                    flipCard.classList.remove('nudge');
                    
                    flipCard.classList.add('shake');
                    playSound('suspense');
                    vibrate([100, 30, 100]);
                    
                    setTimeout(() => {
                        flipCard.classList.remove('shake');
                        flipCard.classList.add('is-flipped');
                        player.revealed = true;
                        
                        // Create particles based on role
                        const roleColor = player.role === 'Impostor' ? '#ff3b30' :
                                        player.role === 'Detective' ? '#007aff' : '#34c759';
                        createParticles(flipCard, roleColor);
                        
                        playSound('pop');
                        vibrate(player.role === 'Impostor' ? [100, 50, 100] : 50);
                    }, 500);
                }
            });
            
            return flipCard;
        }

        // Get Avatar SVG
        function getAvatarSvg(avatarId) {
            const svg = document.getElementById(avatarId).cloneNode(true);
            svg.style.color = 'white';
            return svg.outerHTML;
        }

        // Get Role Icon
        function getRoleIcon(role) {
            let iconId;
            switch (role) {
                case 'Impostor':
                    iconId = 'icon-impostor';
                    break;
                case 'Detective':
                    iconId = 'icon-detective';
                    break;
                case 'Civil':
                    iconId = 'icon-civil';
                    break;
                default:
                    iconId = 'icon-civil';
            }
            const icon = document.getElementById(iconId).cloneNode(true);
            icon.classList.add('role-icon');
            return icon.outerHTML;
        }

        // Reveal All Roles
        function handleRevealRolesClick() {
            gameState.players.forEach(player => player.revealed = true);
            
            // Clear all nudge timers
            Object.values(gameState.cardNudgeTimers).forEach(timer => clearTimeout(timer));
            gameState.cardNudgeTimers = {};
            
            playSound('swoosh');
            vibrate(100);
            renderResultsScreen();
            switchScreen('game-screen', 'results-screen');
        }

        // Render Results Screen
        function renderResultsScreen() {
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                if (player.role === 'Impostor') {
                    resultItem.classList.add('impostor');
                }
                
                const resultAvatar = document.createElement('div');
                resultAvatar.className = 'result-avatar';
                resultAvatar.style.backgroundColor = player.color;
                const avatarSvg = document.getElementById(player.avatar).cloneNode(true);
                avatarSvg.style.color = 'white';
                resultAvatar.appendChild(avatarSvg);
                
                const resultInfo = document.createElement('div');
                resultInfo.className = 'result-info';
                
                const resultName = document.createElement('div');
                resultName.className = 'result-name';
                resultName.textContent = player.name;
                
                const resultRole = document.createElement('div');
                resultRole.className = 'result-role';
                const roleIconSmall = document.getElementById(getRoleIconId(player.role)).cloneNode(true);
                roleIconSmall.classList.add('result-role-icon');
                resultRole.appendChild(roleIconSmall);
                resultRole.appendChild(document.createTextNode(`${player.role} - ${player.word}`));
                
                resultInfo.appendChild(resultName);
                resultInfo.appendChild(resultRole);
                
                if (player.achievement) {
                    const badge = document.createElement('div');
                    badge.className = 'achievement-badge';
                    badge.textContent = player.achievement;
                    badge.style.marginTop = '0.5rem';
                    resultInfo.appendChild(badge);
                }
                
                resultItem.appendChild(resultAvatar);
                resultItem.appendChild(resultInfo);
                resultsList.appendChild(resultItem);
            });
        }

        function getRoleIconId(role) {
            switch (role) {
                case 'Impostor': return 'icon-impostor';
                case 'Detective': return 'icon-detective';
                case 'Civil': return 'icon-civil';
                default: return 'icon-civil';
            }
        }

        // New Game
        function handleNewGame() {
            handleStartGame();
        }

        // Screen Switching
        function switchScreen(currentScreenId, nextScreenId) {
            const currentScreen = document.getElementById(currentScreenId);
            const nextScreen = document.getElementById(nextScreenId);
            
            currentScreen.classList.add('slide-out-to-left');
            
            currentScreen.addEventListener('animationend', function onAnimationEnd() {
                currentScreen.removeEventListener('animationend', onAnimationEnd);
                currentScreen.classList.add('hidden');
                currentScreen.classList.remove('slide-out-to-left');
                
                nextScreen.classList.remove('hidden');
                
                if (nextScreenId === 'results-screen') {
                    nextScreen.classList.add('zoom-in');
                    nextScreen.addEventListener('animationend', function onNextAnimationEnd() {
                        nextScreen.removeEventListener('animationend', onNextAnimationEnd);
                        nextScreen.classList.remove('zoom-in');
                    });
                } else {
                    nextScreen.classList.add('slide-in-from-right');
                    nextScreen.addEventListener('animationend', function onNextAnimationEnd() {
                        nextScreen.removeEventListener('animationend', onNextAnimationEnd);
                        nextScreen.classList.remove('slide-in-from-right');
                    });
                }
            });
        }

        // Loading
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Local Storage
        function saveGameState() {
            const dataToSave = {
                players: gameState.players.map(p => ({ 
                    name: p.name, 
                    color: p.color, 
                    avatar: p.avatar,
                    isSpecial: p.isSpecial,
                    isTroll: p.isTroll
                })),
                selectedCategories: gameState.selectedCategories,
                currentTheme: gameState.currentTheme,
                colorblindMode: gameState.colorblindMode,
                soundEnabled: gameState.soundEnabled,
                impostorStreaks: gameState.impostorStreaks,
                quantumUnlocked: gameState.quantumUnlocked
            };
            localStorage.setItem('imposterWhoGameState', JSON.stringify(dataToSave));
        }

        function loadGameState() {
            const saved = localStorage.getItem('imposterWhoGameState');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState.players = data.players || [];
                    gameState.selectedCategories = data.selectedCategories || ['Pel칤culas', 'Animales', 'Comida'];
                    gameState.currentTheme = data.currentTheme || 'theme-dark';
                    gameState.colorblindMode = data.colorblindMode || false;
                    gameState.soundEnabled = data.soundEnabled !== undefined ? data.soundEnabled : true;
                    gameState.impostorStreaks = data.impostorStreaks || {};
                    gameState.quantumUnlocked = data.quantumUnlocked || false;
                    
                    setTheme(gameState.currentTheme);
                    document.getElementById('colorblind-toggle').checked = gameState.colorblindMode;
                    if (gameState.colorblindMode) {
                        document.body.classList.add('colorblind-mode');
                    }
                    
                    document.getElementById('sound-icon').textContent = gameState.soundEnabled ? '游댉' : '游댆';
                    
                    renderPlayerList();
                } catch (error) {
                    console.error('Error loading game state:', error);
                }
            }
        }
    </script>
</body>
</html>
