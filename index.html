<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Who?</title>
    <meta name="description" content="Un juego de deducci√≥n social para encontrar al impostor.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1c1c1e">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <!-- Dictionary -->
    <script src="words.js" defer></script>

    <style>
        :root {
            --bg-primary: #1c1c1e;
            --bg-secondary: rgba(42, 42, 45, 0.85);
            --bg-secondary-opaque: #2a2a2d;
            --text-primary: #e6e6e6;
            --text-secondary: #8e8e93;
            --accent-color: #0A84FF;
            --accent-highlight: #3395ff;
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --border-color: rgba(230, 230, 230, 0.2);
            --separator-color: rgba(84, 84, 88, 0.65);
            --shadow-color: rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .font-title {
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .liquid-glass {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05), 0 4px 20px var(--shadow-color);
        }

        .liquid-button {
            background-color: rgba(58, 58, 60, 0.7);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .liquid-button:hover {
            background-color: rgba(72, 72, 74, 0.8);
        }

        .liquid-input {
            background-color: var(--bg-secondary-opaque);
            border: 1px solid var(--border-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .liquid-input:focus {
            border-color: var(--accent-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 0 2px rgba(10, 132, 255, 0.5);
        }
        
        /* Card flip animation */
        .flip-card { perspective: 1000px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.is-flipped .flip-card-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card-face-back { transform: rotateY(180deg); }
        
        .reveal-footer-button {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none;
        }
        .reveal-footer-button.is-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- ===== CONFIG SCREEN ===== -->
    <div id="config-screen" class="w-full max-w-lg mx-auto">
        <div class="relative flex size-full min-h-screen flex-col justify-between">
            <div>
                <header class="text-center p-4 sticky top-0 bg-black/30 backdrop-blur-md z-10 border-b border-[var(--separator-color)]">
                    <h1 class="text-lg font-semibold">Configurar Partida</h1>
                </header>
                <main class="p-4 space-y-6 pb-24">
                    <section class="liquid-glass p-4">
                        <h2 class="text-xl font-bold mb-4">Jugadores</h2>
                        <div class="flex items-center gap-2 mb-4">
                            <input id="player-name-input" type="text" class="form-input flex-1 liquid-input rounded-xl h-12 px-4 text-base focus:ring-0 text-[var(--text-primary)]" placeholder="Nombre del jugador..."/>
                            <input type="color" id="player-color-input" value="#0A84FF" class="w-12 h-12 rounded-xl cursor-pointer liquid-input p-1">
                            <button id="add-player-btn" class="bg-[var(--accent-color)] h-12 w-12 flex items-center justify-center rounded-xl shadow-[0_2px_8px_rgba(10,132,255,0.4)]">
                                <span class="material-symbols-outlined text-3xl text-white">add</span>
                            </button>
                        </div>
                        <div id="player-list" class="space-y-0.5 divide-y divide-[var(--separator-color)]">
                            <!-- Player list injected here -->
                        </div>
                    </section>

                    <section class="liquid-glass p-4">
                        <h2 class="text-xl font-bold mb-4">Opciones</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="text-base font-medium mb-2 block" for="impostor-count">N√∫mero de Impostores</label>
                                <select id="impostor-count" class="form-select w-full liquid-input rounded-xl h-12 px-4 focus:ring-0">
                                    <option value="1">1</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-base font-medium mb-2 block" for="difficulty">Dificultad</label>
                                <select id="difficulty" class="form-select w-full liquid-input rounded-xl h-12 px-4 focus:ring-0">
                                    <option value="random">Aleatoria</option>
                                    <option value="easy">F√°cil</option>
                                    <option value="medium">Media</option>
                                    <option value="hard">Dif√≠cil</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    
                    <section class="liquid-glass p-4">
                        <h2 class="text-xl font-bold mb-3">Modos de Juego</h2>
                        <div class="grid grid-cols-1 divide-y divide-[var(--separator-color)]">
                            <label class="flex items-center justify-between gap-3 py-3"><span class="text-base flex-1">üí° Pista para Impostor</span><input type="checkbox" id="impostor-hint-mode" class="form-checkbox h-6 w-6 rounded-md bg-transparent border-2 border-[var(--border-color)] checked:bg-[var(--accent-color)] focus:ring-0 focus:ring-offset-0"></label>
                            <label class="flex items-center justify-between gap-3 py-3"><span class="text-base flex-1">ü§° Modo Troll</span><input type="checkbox" id="troll-mode" class="form-checkbox h-6 w-6 rounded-md bg-transparent border-2 border-[var(--border-color)] checked:bg-[var(--accent-color)] focus:ring-0 focus:ring-offset-0"></label>
                            <label class="flex items-center justify-between gap-3 py-3"><span class="text-base flex-1">üïµÔ∏è Modo Detective</span><input type="checkbox" id="detective-mode" class="form-checkbox h-6 w-6 rounded-md bg-transparent border-2 border-[var(--border-color)] checked:bg-[var(--accent-color)] focus:ring-0 focus:ring-offset-0"></label>
                        </div>
                    </section>

                    <section class="liquid-glass p-4">
                        <h2 class="text-xl font-bold mb-3">Categor√≠as</h2>
                        <div id="category-list" class="max-h-48 overflow-y-auto grid grid-cols-1 divide-y divide-[var(--separator-color)] pr-2">
                            <!-- Categories will be injected here -->
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 mt-6">
                            <button id="surprise-me-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-4 liquid-button text-[var(--text-primary)] text-sm font-semibold rounded-xl">‚ú® Sorpr√©ndeme</button>
                            <button id="select-all-btn" class="flex-1 flex items-center justify-center gap-2 py-3 px-4 liquid-button text-[var(--text-primary)] text-sm font-semibold rounded-xl">Seleccionar Todas</button>
                        </div>
                        <button id="ai-category-btn" class="mt-3 w-full flex items-center justify-center gap-2 py-3 px-4 liquid-button text-[var(--text-primary)] text-sm font-semibold rounded-xl">ü§ñ Crear con IA</button>
                    </section>
                </main>
            </div>
            <footer class="p-4 sticky bottom-0 bg-black/30 backdrop-blur-md border-t border-[var(--separator-color)]">
                <button id="start-game-btn" class="w-full py-4 text-center bg-[var(--accent-color)] text-white text-lg font-bold rounded-xl shadow-[0_4px_15px_rgba(10,132,255,0.5)] disabled:bg-[rgba(58,58,60,0.8)] disabled:text-[var(--text-secondary)] disabled:shadow-none">Asignar Roles</button>
            </footer>
        </div>
    </div>

    <!-- ===== ROLE REVEAL SCREEN ===== -->
    <div id="reveal-screen" class="w-full max-w-lg mx-auto hidden">
        <div class="relative flex size-full min-h-screen flex-col justify-between">
            <main class="flex flex-col items-center justify-center flex-grow px-4 text-center">
                <p class="text-[var(--text-secondary)] text-lg mb-2">P√°sale el m√≥vil a:</p>
                <h2 id="current-player-name" class="text-4xl font-bold mb-8"></h2>
                
                <div id="role-card" class="flip-card w-full max-w-xs aspect-[3/4.5] cursor-pointer">
                    <div class="flip-card-inner">
                        <div class="card-face card-face-front liquid-glass">
                            <span class="material-symbols-outlined text-8xl text-[var(--text-secondary)]">contact_support</span>
                            <h3 class="text-2xl font-semibold mt-4">Imposter Who?</h3>
                            <p class="text-[var(--text-secondary)] mt-2">Toca para Revelar</p>
                        </div>
                        <div id="card-back-content" class="card-face card-face-back liquid-glass p-6">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="p-4 reveal-footer-button">
                <button id="next-player-btn" class="flex w-full max-w-sm mx-auto items-center justify-center rounded-xl h-12 px-5 bg-black/20 backdrop-blur-sm text-[var(--accent-color)] text-lg font-semibold border border-white/10">
                    Siguiente Jugador
                </button>
            </footer>
        </div>
    </div>
    
    <!-- ===== GAME SCREEN ===== -->
    <div id="game-screen" class="w-full max-w-lg mx-auto hidden">
        <div class="relative flex size-full min-h-screen flex-col justify-between">
            <main class="flex-grow flex flex-col justify-center px-6 py-8">
                <div class="text-center mb-10">
                    <h1 class="font-title text-5xl font-black tracking-tighter drop-shadow-lg">¬°A Jugar!</h1>
                    <p class="text-base text-[var(--text-secondary)] mt-2 drop-shadow-sm">Escucha con atenci√≥n. El impostor est√° entre nosotros.</p>
                </div>
                <div class="liquid-glass p-6 space-y-6">
                    <div class="text-center">
                        <p class="text-sm font-medium uppercase tracking-wider text-[var(--text-secondary)]">Empieza la ronda</p>
                        <div class="flex items-center justify-center gap-4 mt-3">
                            <div id="starting-player-avatar" class="h-16 w-16 rounded-full border-2 border-[var(--accent-color)] shadow-lg" style="box-shadow: 0 0 15px var(--accent-color-shadow, rgba(10, 132, 255, 0.5));"></div>
                            <p id="starting-player-announcement" class="font-title text-3xl font-bold text-[var(--accent-highlight)] drop-shadow-md"></p>
                        </div>
                    </div>
                    <div id="reason-container" class="text-center bg-black/20 p-4 rounded-2xl shadow-inner shadow-black/30 min-h-[6rem] flex flex-col justify-center">
                        <p id="starting-player-reason" class="text-lg italic drop-shadow-sm"></p>
                        <p id="reason-label" class="text-xs font-semibold uppercase tracking-widest text-[var(--text-secondary)] mt-3 hidden">Raz√≥n Generada por IA</p>
                    </div>
                    <div id="final-reveal-info" class="hidden text-left space-y-2 pt-4 border-t border-[var(--separator-color)]">
                         <p class="text-lg">La palabra era: <strong id="final-word" class="text-[var(--accent-highlight)]"></strong></p>
                         <div id="final-impostors"></div>
                    </div>
                </div>
            </main>
            <footer class="px-6 pb-8 pt-4 sticky bottom-0">
                <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-primary)] to-transparent -z-10"></div>
                <button id="reveal-roles-btn" class="w-full flex items-center justify-center gap-3 rounded-2xl h-14 px-5 bg-black/20 text-[var(--accent-color)] text-lg font-bold tracking-wide shadow-lg backdrop-blur-lg border border-[var(--border-color)] hover:bg-black/30 transition-all">
                    <span class="material-symbols-outlined">visibility</span>
                    <span>Revelar Roles y Palabra</span>
                </button>
                 <button id="new-game-btn" class="mt-4 w-full flex items-center justify-center gap-3 rounded-2xl h-14 px-5 bg-black/20 text-[var(--text-secondary)] text-lg font-bold tracking-wide shadow-lg backdrop-blur-lg border border-[var(--border-color)] hover:bg-black/30 transition-all">
                    <span class="material-symbols-outlined">refresh</span>
                    <span>Jugar de Nuevo</span>
                </button>
            </footer>
        </div>
    </div>
    
    <!-- Loading/Modal Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="text-white text-2xl animate-pulse">Generando con IA...</div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    const state = {
        roles: {},
        secretWord: '',
        secretCategory: '',
        currentPlayerIndex: 0,
        lastRoundImpostors: [],
        gameStarted: false,
        startingPlayer: null,
        hintForImpostorAvailable: false,
        persistentConfig: {
            players: [],
            selectedCategories: new Set(),
            gameModes: { impostorHint: false, troll: false, detective: false },
        },
        generatedWordsCache: {},
    };

    // --- DOM ELEMENTS ---
    const screens = {
        config: document.getElementById('config-screen'),
        reveal: document.getElementById('reveal-screen'),
        game: document.getElementById('game-screen'),
    };
    const playerNameInput = document.getElementById('player-name-input');
    const playerColorInput = document.getElementById('player-color-input');
    const addPlayerBtn = document.getElementById('add-player-btn');
    const playerList = document.getElementById('player-list');
    const impostorCountSelect = document.getElementById('impostor-count');
    const difficultySelect = document.getElementById('difficulty');
    const categoryList = document.getElementById('category-list');
    const surpriseMeBtn = document.getElementById('surprise-me-btn');
    const selectAllBtn = document.getElementById('select-all-btn');
    const aiCategoryBtn = document.getElementById('ai-category-btn');
    const impostorHintMode = document.getElementById('impostor-hint-mode');
    const trollMode = document.getElementById('troll-mode');
    const detectiveMode = document.getElementById('detective-mode');
    const startGameBtn = document.getElementById('start-game-btn');
    const currentPlayerName = document.getElementById('current-player-name');
    const roleCard = document.getElementById('role-card');
    const cardBackContent = document.getElementById('card-back-content');
    const nextPlayerBtn = document.getElementById('next-player-btn');
    const revealFooter = document.querySelector('.reveal-footer-button');
    const startingPlayerAnnouncement = document.getElementById('starting-player-announcement');
    const startingPlayerAvatar = document.getElementById('starting-player-avatar');
    const startingPlayerReason = document.getElementById('starting-player-reason');
    const reasonLabel = document.getElementById('reason-label');
    const revealRolesBtn = document.getElementById('reveal-roles-btn');
    const newGameBtn = document.getElementById('new-game-btn');
    const finalRevealInfo = document.getElementById('final-reveal-info');
    const finalWord = document.getElementById('final-word');
    const finalImpostors = document.getElementById('final-impostors');
    const loadingOverlay = document.getElementById('loading-overlay');

    // --- INITIALIZATION ---
    function initialize() {
        loadConfig();
        populateCategories();
        addEventListeners();
        updateUI();
        registerServiceWorker();
    }

    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    }
    
    // --- CONFIG PERSISTENCE ---
    function saveConfig() {
        const configToSave = {
            ...state.persistentConfig,
            selectedCategories: Array.from(state.persistentConfig.selectedCategories)
        };
        localStorage.setItem('imposterWhoConfig', JSON.stringify(configToSave));
    }

    function loadConfig() {
        const savedConfig = localStorage.getItem('imposterWhoConfig');
        if (savedConfig) {
            const parsedConfig = JSON.parse(savedConfig);
            state.persistentConfig.players = parsedConfig.players || [];
            state.persistentConfig.selectedCategories = new Set(parsedConfig.selectedCategories || []);
            state.persistentConfig.gameModes = parsedConfig.gameModes || { impostorHint: false, troll: false, detective: false };
        }
    }

    // --- EVENT LISTENERS ---
    function addEventListeners() {
        addPlayerBtn.addEventListener('click', addPlayer);
        playerNameInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') addPlayer(); });
        surpriseMeBtn.addEventListener('click', handleSurpriseMeClick);
        selectAllBtn.addEventListener('click', toggleSelectAllCategories);
        aiCategoryBtn.addEventListener('click', handleAICategoryGeneration);
        impostorHintMode.addEventListener('change', (e) => { state.persistentConfig.gameModes.impostorHint = e.target.checked; saveConfig(); });
        trollMode.addEventListener('change', (e) => { state.persistentConfig.gameModes.troll = e.target.checked; saveConfig(); });
        detectiveMode.addEventListener('change', (e) => { state.persistentConfig.gameModes.detective = e.target.checked; saveConfig(); updateUI(); });
        startGameBtn.addEventListener('click', startGame);
        roleCard.addEventListener('click', () => { roleCard.classList.add('is-flipped'); revealFooter.classList.add('is-visible'); });
        nextPlayerBtn.addEventListener('click', nextPlayer);
        revealRolesBtn.addEventListener('click', handleRevealRolesClick);
        newGameBtn.addEventListener('click', resetForNewGame);
    }

    // --- UI UPDATE FUNCTIONS ---
    function updateUI() {
        impostorHintMode.checked = state.persistentConfig.gameModes.impostorHint;
        trollMode.checked = state.persistentConfig.gameModes.troll;
        detectiveMode.checked = state.persistentConfig.gameModes.detective;
        renderPlayerList();
        updateImpostorCountOptions();
        updateStartButtonState();
        updateCategoryCheckboxes();
    }
    
    function updateCategoryCheckboxes() {
        document.querySelectorAll('.category-checkbox').forEach(box => {
            box.checked = state.persistentConfig.selectedCategories.has(box.dataset.category);
        });
    }

    function switchScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }

    function renderPlayerList() {
        playerList.innerHTML = '';
        state.persistentConfig.players.forEach((player, index) => {
            const playerEl = document.createElement('div');
            playerEl.className = 'flex items-center gap-4 py-2';
            playerEl.innerHTML = `
                <div class="size-10 rounded-full" style="background-color: ${player.color};"></div>
                <p class="text-base font-medium flex-1">${player.name}</p>
                <button data-index="${index}" class="remove-player-btn text-[var(--text-secondary)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
            `;
            playerList.appendChild(playerEl);
        });
        document.querySelectorAll('.remove-player-btn').forEach(btn => {
            btn.addEventListener('click', (e) => removePlayer(parseInt(e.currentTarget.dataset.index)));
        });
    }

    function updateImpostorCountOptions() {
        const maxImpostors = state.persistentConfig.players.length >= 5 ? 2 : 1;
        impostorCountSelect.innerHTML = '<option value="1">1</option>';
        if (maxImpostors === 2) {
            impostorCountSelect.innerHTML += '<option value="2">2</option>';
        }
    }

    function updateStartButtonState() {
        const minPlayers = state.persistentConfig.gameModes.detective ? 4 : 3;
        const isReady = state.persistentConfig.players.length >= minPlayers && state.persistentConfig.selectedCategories.size > 0;
        startGameBtn.disabled = !isReady;
        startGameBtn.textContent = isReady ? 'Asignar Roles' : `M√≠n ${minPlayers} jugadores y 1 categor√≠a`;
    }

    function populateCategories(newCategory = null) {
        if (newCategory) {
            WORD_CATEGORIES[newCategory.name] = {};
            state.generatedWordsCache[newCategory.name] = newCategory.words;
        }
        const categoryNames = Object.keys(WORD_CATEGORIES);
        categoryList.innerHTML = '';
        categoryNames.forEach(cat => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-3 py-3 cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" data-category="${cat}" class="category-checkbox form-checkbox size-6 border-2 focus:ring-0 focus:ring-offset-0 bg-transparent border-[var(--border-color)] checked:bg-[var(--accent-color)]"/>
                <span class="text-base flex-1">${cat}</span>
            `;
            categoryList.appendChild(label);
        });
        document.querySelectorAll('.category-checkbox').forEach(box => {
            box.addEventListener('change', (e) => {
                const category = e.target.dataset.category;
                if (e.target.checked) state.persistentConfig.selectedCategories.add(category);
                else state.persistentConfig.selectedCategories.delete(category);
                saveConfig();
                updateStartButtonState();
            });
        });
        updateCategoryCheckboxes();
    }

    // --- PLAYER MANAGEMENT ---
    function addPlayer() {
        const name = playerNameInput.value.trim();
        if (name && state.persistentConfig.players.length < 12) {
            state.persistentConfig.players.push({ name, color: playerColorInput.value });
            playerNameInput.value = '';
            playerNameInput.focus();
            saveConfig();
            updateUI();
        }
    }

    function removePlayer(index) {
        state.persistentConfig.players.splice(index, 1);
        saveConfig();
        updateUI();
    }

    // --- CATEGORY MANAGEMENT ---
    // BUG FIX: Centralized function to add any new category to the game state.
    function addNewCategoryToGame(categoryData, select = false) {
        populateCategories(categoryData);
        if (select) {
            state.persistentConfig.selectedCategories.clear();
            document.querySelectorAll('.category-checkbox').forEach(box => box.checked = false);
            const newCheckbox = document.querySelector(`.category-checkbox[data-category="${categoryData.name}"]`);
            if (newCheckbox) {
                newCheckbox.checked = true;
                state.persistentConfig.selectedCategories.add(categoryData.name);
            }
            saveConfig();
        }
        updateStartButtonState();
        alert(`¬°Categor√≠a "${categoryData.name}" creada y a√±adida!`);
    }

    async function handleSurpriseMeClick() {
        loadingOverlay.classList.remove('hidden');
        try {
            const response = await fetch('/api/generate-random-category', { method: 'POST' });
            if (!response.ok) throw new Error('No se pudo generar la categor√≠a sorpresa.');
            const newCategory = await response.json();
            addNewCategoryToGame({ name: newCategory.name, words: newCategory.words }, true);
        } catch (error) {
            console.error('Error getting surprise category:', error);
            alert(`Error: ${error.message}`);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    
    async function handleAICategoryGeneration() {
        const topic = prompt("Introduce el tema para la nueva categor√≠a (ej: 'Superh√©roes'):");
        if (!topic || topic.trim() === '') return;
        loadingOverlay.classList.remove('hidden');
        try {
            const newWords = await getWordsForCategory(topic, true); // Force fetch new words
            addNewCategoryToGame({ name: topic, words: newWords });
        } catch (error) {
            console.error('Error generating AI category:', error);
            alert(`Error: ${error.message}`);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    function toggleSelectAllCategories() {
        const checkboxes = document.querySelectorAll('.category-checkbox');
        const allSelected = checkboxes.length > 0 && Array.from(checkboxes).every(box => box.checked);
        checkboxes.forEach(box => {
            box.checked = !allSelected;
            const category = box.dataset.category;
            if (!allSelected) state.persistentConfig.selectedCategories.add(category);
            else state.persistentConfig.selectedCategories.delete(category);
        });
        saveConfig();
        updateStartButtonState();
    }

    // --- WORD GENERATION (Refactored) ---
    async function getWordsForCategory(categoryName, forceFetch = false) {
        if (!forceFetch && state.generatedWordsCache[categoryName] && Object.keys(state.generatedWordsCache[categoryName]).length > 0) {
            return state.generatedWordsCache[categoryName];
        }
        
        try {
            const response = await fetch('/api/generate-category', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic: categoryName }),
            });
            if (!response.ok) throw new Error('La API no pudo generar palabras.');
            const newWords = await response.json();
            state.generatedWordsCache[categoryName] = newWords;
            return newWords;
        } catch (error) {
            throw new Error(`Fallo al obtener palabras para ${categoryName}: ${error.message}`);
        }
    }

    // --- GAME LOGIC ---
    async function startGame() {
        state.gameStarted = true;
        loadingOverlay.classList.remove('hidden');
        try {
            await assignRoles();
            state.startingPlayer = state.persistentConfig.players[Math.floor(Math.random() * state.persistentConfig.players.length)];
            state.hintForImpostorAvailable = state.persistentConfig.gameModes.impostorHint && state.roles[state.startingPlayer.name].role === 'Impostor';
            state.currentPlayerIndex = 0;
            setupRevealScreen();
            switchScreen('reveal');
        } catch (error) {
            console.error("Error starting game:", error);
            alert("No se pudieron generar las palabras para la partida. Revisa la conexi√≥n o int√©ntalo de nuevo.");
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function assignRoles() {
        const availableCategories = Array.from(state.persistentConfig.selectedCategories);
        state.secretCategory = availableCategories[Math.floor(Math.random() * availableCategories.length)];
        
        const wordsInCat = await getWordsForCategory(state.secretCategory);

        const difficulty = difficultySelect.value;
        let difficultyPool = (difficulty === 'random')
            ? [...wordsInCat.easy, ...wordsInCat.medium, ...wordsInCat.hard]
            : wordsInCat[difficulty];
        state.secretWord = difficultyPool[Math.floor(Math.random() * difficultyPool.length)];

        let playerNames = state.persistentConfig.players.map(p => p.name).sort(() => Math.random() - 0.5);
        state.roles = {};
        const isTrollRound = state.persistentConfig.gameModes.troll && Math.random() < 0.15;
        if (isTrollRound) {
            playerNames.forEach(name => state.roles[name] = { role: 'Impostor', isTroll: true });
            state.lastRoundImpostors = [...playerNames];
            return;
        }

        let potentialImpostors = playerNames.filter(name => !state.lastRoundImpostors.includes(name));
        const impostorCount = parseInt(impostorCountSelect.value);
        if (potentialImpostors.length < impostorCount) potentialImpostors = [...playerNames];
        const impostors = [];
        while (impostors.length < impostorCount) {
            const idx = Math.floor(Math.random() * potentialImpostors.length);
            impostors.push(potentialImpostors.splice(idx, 1)[0]);
        }
        state.lastRoundImpostors = [...impostors];

        let detective = null;
        if (state.persistentConfig.gameModes.detective) {
            const potentialDetectives = playerNames.filter(name => !impostors.includes(name));
            detective = potentialDetectives[Math.floor(Math.random() * potentialDetectives.length)];
        }

        playerNames.forEach(name => {
            if (impostors.includes(name)) state.roles[name] = { role: 'Impostor' };
            else if (name === detective) state.roles[name] = { role: 'Detective' };
            else state.roles[name] = { role: 'Civil' };
        });
    }

    function setupRevealScreen() {
        const player = state.persistentConfig.players[state.currentPlayerIndex];
        currentPlayerName.textContent = player.name;
        currentPlayerName.style.color = player.color;
        roleCard.classList.remove('is-flipped');
        revealFooter.classList.remove('is-visible');
        updateCardBack(player);
    }

    function updateCardBack(player) {
        const playerRole = state.roles[player.name];
        let content = '';
        const getRoleTranslation = (role) => (role === 'Civil') ? 'Civil' : (role === 'Detective') ? 'Detective' : 'Impostor';

        if (playerRole.role === 'Impostor') {
            content = `<div class="text-center my-auto"><h3 class="text-5xl font-bold uppercase tracking-wider text-[var(--accent-red)]" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5)">IMPOSTOR</h3><p class="text-[var(--text-secondary)] mt-4">Descubre la palabra secreta.</p></div>`;
            if (state.hintForImpostorAvailable && player.name === state.startingPlayer.name) {
                content += `<button id="get-hint-btn" class="mb-4 bg-white/10 text-white font-semibold py-2 px-4 rounded-lg">Pedir Pista a la IA</button>`;
            }
        } else {
            const roleColor = playerRole.role === 'Detective' ? 'var(--accent-color)' : 'var(--accent-green)';
            content = `<div class="text-left w-full"><p class="text-xs uppercase tracking-wider text-[var(--text-secondary)]">Categor√≠a</p><h4 class="text-xl font-semibold">${state.secretCategory}</h4></div><div class="text-center my-auto"><h3 class="text-4xl font-bold uppercase tracking-wider" style="color:${roleColor}; text-shadow: 0 1px 3px rgba(0,0,0,0.5)">${getRoleTranslation(playerRole.role)}</h3><p class="text-5xl font-bold mt-4">${state.secretWord}</p></div><div class="w-full"></div>`;
        }
        cardBackContent.innerHTML = content;
        const hintBtn = document.getElementById('get-hint-btn');
        if (hintBtn) hintBtn.addEventListener('click', getAIHint);
    }

    function nextPlayer() {
        revealFooter.classList.remove('is-visible');
        roleCard.classList.remove('is-flipped');
        setTimeout(() => {
            state.currentPlayerIndex++;
            if (state.currentPlayerIndex < state.persistentConfig.players.length) setupRevealScreen();
            else showGameScreen();
        }, 600);
    }

    async function showGameScreen() {
        startingPlayerAnnouncement.textContent = state.startingPlayer.name;
        startingPlayerAvatar.style.backgroundColor = state.startingPlayer.color;
        startingPlayerAvatar.style.boxShadow = `0 0 15px ${state.startingPlayer.color}80`;
        finalRevealInfo.classList.add('hidden');
        revealRolesBtn.querySelector('span:last-child').textContent = 'Revelar Roles y Palabra';
        startingPlayerReason.textContent = '‚ú® Generando una raz√≥n creativa...';
        reasonLabel.classList.add('hidden');
        switchScreen('game');

        try {
            const response = await fetch('/api/generate-starting-reason', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerName: state.startingPlayer.name }),
            });
            if (!response.ok) throw new Error('No se pudo obtener la raz√≥n de inicio.');
            const data = await response.json();
            startingPlayerReason.textContent = `"${data.reason}"`;
            reasonLabel.classList.remove('hidden');
        } catch (error) {
            console.error("Could not get starting reason:", error);
            startingPlayerReason.textContent = '¬°Que comience el juego!';
            reasonLabel.classList.add('hidden');
        }
    }
    
    function handleRevealRolesClick() {
        const isHidden = finalRevealInfo.classList.contains('hidden');
        const buttonText = revealRolesBtn.querySelector('span:last-child');
        if (isHidden) {
            finalWord.textContent = state.secretWord;
            let impostorHtml = '<p class="text-base text-[var(--text-secondary)]">Los impostores eran:</p><ul class="list-disc list-inside">';
            let detectiveHtml = '';
            state.persistentConfig.players.forEach(player => {
                const roleInfo = state.roles[player.name];
                if (roleInfo.role === 'Impostor') impostorHtml += `<li style="color: ${player.color};">${player.name}</li>`;
                if (roleInfo.role === 'Detective') detectiveHtml = `<p class="text-base text-[var(--text-secondary)] mt-2">El detective era: <strong style="color: ${player.color};">${player.name}</strong></p>`;
            });
            impostorHtml += '</ul>';
            if (state.persistentConfig.players.length > 0 && state.roles[state.persistentConfig.players[0].name]?.isTroll) {
               impostorHtml = `<p class="text-lg text-[var(--accent-red)] font-bold">¬°RONDA TROLL! ¬°Todos eran impostores!</p>`;
            }
            finalImpostors.innerHTML = impostorHtml + detectiveHtml;
            finalRevealInfo.classList.remove('hidden');
            buttonText.textContent = 'Ocultar Roles';
        } else {
            finalRevealInfo.classList.add('hidden');
            buttonText.textContent = 'Revelar Roles y Palabra';
        }
    }

    function resetForNewGame() {
        state.roles = {};
        state.secretWord = '';
        state.secretCategory = '';
        state.currentPlayerIndex = 0;
        state.gameStarted = false;
        state.startingPlayer = null;
        state.hintForImpostorAvailable = false;
        switchScreen('config');
    }
    
    async function getAIHint(event) {
        event.stopPropagation();
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Pensando...';
        try {
            const response = await fetch('/api/generate-hint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category: state.secretCategory }),
            });
            if (!response.ok) throw new Error('No se pudo obtener la pista.');
            const data = await response.json();
            const hintEl = document.createElement('p');
            hintEl.className = 'mt-4 text-xl text-yellow-300';
            hintEl.innerHTML = `<strong>Pista:</strong> ${data.hint}`;
            btn.replaceWith(hintEl);
        } catch (error) {
            console.error('Error getting AI hint:', error);
            alert(`Error: ${error.message}`);
            btn.textContent = 'Reintentar';
            btn.disabled = false;
        }
    }

    // --- START ---
    initialize();
});
</script>

</body>
</html>
